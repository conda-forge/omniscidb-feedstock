From 9cea9b7fbb818af186042e32a63d3944a3adaf9b Mon Sep 17 00:00:00 2001
From: Guilherme Leobas <guilhermeleobas@gmail.com>
Date: Sat, 5 Feb 2022 17:39:58 -0300
Subject: [PATCH] Fixes for windows build on conda-forge

---
 CMakeLists.txt                        | 4 +++-
 DataMgr/BufferMgr/BufferMgr.h         | 3 +++
 StringDictionary/DictRef.h            | 1 +
 StringDictionary/StringDictionary.cpp | 6 ++++++
 4 files changed, 13 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index dfda618784..a902c6472e 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -16,7 +16,9 @@ if(DEFINED ENV{CONDA_PREFIX})
   # Adding formating macros
   add_definitions("-D__STDC_FORMAT_MACROS=1")
   # fixes always_inline attribute errors
-  add_compile_options("-fno-semantic-interposition")
+  if (NOT DEFINED MSVC)
+    add_compile_options("$<$<COMPILE_LANGUAGE:CXX>:-fno-semantic-interposition>")
+  endif()
   # Adding `--sysroot=...` resolves `no member named 'signbit' in the global namespace` error:
   set(CMAKE_SYSROOT "$ENV{CONDA_BUILD_SYSROOT}")
 endif(DEFINED ENV{CONDA_PREFIX})
diff --git a/DataMgr/BufferMgr/BufferMgr.h b/DataMgr/BufferMgr/BufferMgr.h
index 1df594918b..cfbdad4159 100644
--- a/DataMgr/BufferMgr/BufferMgr.h
+++ b/DataMgr/BufferMgr/BufferMgr.h
@@ -34,6 +34,9 @@
 #include "DataMgr/AbstractBuffer.h"
 #include "DataMgr/AbstractBufferMgr.h"
 #include "DataMgr/BufferMgr/BufferSeg.h"
+#if defined(_WIN32)
+#include <WinSock2.h>
+#endif
 #include "Shared/boost_stacktrace.hpp"
 #include "Shared/types.h"
 
diff --git a/StringDictionary/DictRef.h b/StringDictionary/DictRef.h
index 62456859ee..5e9f8cb1dc 100644
--- a/StringDictionary/DictRef.h
+++ b/StringDictionary/DictRef.h
@@ -4,6 +4,7 @@
 #include <cstdint>
 #include <cstdlib>
 #include <functional>
+#include <string>
 
 struct dict_ref_t {
   int32_t dbId;
diff --git a/StringDictionary/StringDictionary.cpp b/StringDictionary/StringDictionary.cpp
index 23cf7262b1..4cb401ade7 100644
--- a/StringDictionary/StringDictionary.cpp
+++ b/StringDictionary/StringDictionary.cpp
@@ -43,6 +43,12 @@
 
 #include "LeafHostInfo.h"
 
+#ifdef _WIN32
+#if defined(ERROR) || defined(INFO) || defined(WARNING) || defined(FATAL)
+#include "Shared/cleanup_global_namespace.h"
+#endif
+#endif
+
 bool g_cache_string_hash{true};
 
 namespace {
-- 
2.33.0.windows.1

