From a26300e5f87e87d261f6850026fa49e24387d3e7 Mon Sep 17 00:00:00 2001
From: Guilherme Leobas <guilhermeleobas@gmail.com>
Date: Thu, 17 Feb 2022 16:32:13 -0300
Subject: [PATCH] Fix Windows build

---
 CMakeLists.txt                                 | 10 ++++++----
 Catalog/OptionsContainer.h                     |  2 +-
 DataMgr/BufferMgr/BufferMgr.h                  |  3 +++
 DataMgr/ForeignStorage/ArrowForeignStorage.cpp |  8 ++++----
 StringDictionary/DictRef.h                     |  1 +
 StringDictionary/StringDictionary.cpp          |  6 ++++++
 ThirdParty/rapidjson/rapidjson/document.h      | 17 +++++++++++++++++
 ThirdParty/sqlite3/CMakeLists.txt              |  2 +-
 ThirdParty/sqlite3/sqlite3.c                   |  2 +-
 9 files changed, 40 insertions(+), 11 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index dfda618784..8e212d9eab 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -8,7 +8,7 @@ if(DEFINED ENV{CONDA_PREFIX})
   set(ENABLE_CONDA ON)
   list(APPEND CMAKE_PREFIX_PATH "$ENV{CONDA_PREFIX}")
   # resolves link issue for zlib 
-  link_directories("$ENV{CONDA_PREFIX}/lib")
+  link_directories("$ENV{CONDA_PREFIX}/lib" "$ENV{CONDA_PREFIX}/Library/lib")
   # various fixes and workarounds
   add_definitions("-Dsecure_getenv=getenv")
   # fixes `undefined reference to `boost::system::detail::system_category_instance'`:
@@ -16,7 +16,9 @@ if(DEFINED ENV{CONDA_PREFIX})
   # Adding formating macros
   add_definitions("-D__STDC_FORMAT_MACROS=1")
   # fixes always_inline attribute errors
-  add_compile_options("-fno-semantic-interposition")
+  if (DEFINED MSVC)
+    add_compile_options("$<$<COMPILE_LANGUAGE:CXX>:-fno-semantic-interposition>")
+  endif()
   # Adding `--sysroot=...` resolves `no member named 'signbit' in the global namespace` error:
   set(CMAKE_SYSROOT "$ENV{CONDA_BUILD_SYSROOT}")
 endif(DEFINED ENV{CONDA_PREFIX})
@@ -389,7 +391,7 @@ if(MSVC)
   option(ENABLE_NO_WINWARNINGS "disable most windows warnings" ON)
   add_compile_definitions("NOMINMAX")
   if(ENABLE_NO_WINWARNINGS)
-    add_compile_definitions("_STL_EXTRA_DISABLED_WARNINGS=4146 4242 4244 4267 4355 4365 4458 4624 4820 4996 5204 5219" "NOMINMAX")
+    add_compile_definitions("_STL_EXTRA_DISABLED_WARNINGS=4146 4242 4244 4267 4355 4365 4458 4624 4820 4996 5204 5219 4571 4582 4583 4623 4625 4626 4710 4711 4774 5026 5027" "NOMINMAX")
     # disable 4702 unreachable code warning
     # with /Qspectre set, disable the warning C5045
     add_compile_options(/W0 /wd4702 /wd5045)
@@ -922,7 +924,7 @@ add_custom_target(rerun_cmake ALL
   )
 add_dependencies(omnisci_server rerun_cmake)
 
-target_link_libraries(omnisci_server mapd_thrift thrift_handler ${MAPD_LIBRARIES} ${Boost_LIBRARIES} ${CMAKE_DL_LIBS} ${CUDA_LIBRARIES} ${PROFILER_LIBS} ${ZLIB_LIBRARIES} ${LOCALE_LINK_FLAG})
+target_link_libraries(omnisci_server mapd_thrift thrift_handler sqlite3 ${MAPD_LIBRARIES} ${Boost_LIBRARIES} ${CMAKE_DL_LIBS} ${CUDA_LIBRARIES} ${PROFILER_LIBS} ${ZLIB_LIBRARIES} ${LOCALE_LINK_FLAG})
 
 target_link_libraries(initdb mapd_thrift thrift_handler ${MAPD_LIBRARIES} ${Boost_LIBRARIES} ${CMAKE_DL_LIBS}
     ${CUDA_LIBRARIES} ${PROFILER_LIBS} ${ZLIB_LIBRARIES} ${BLOSC_LIBRARIES}
diff --git a/Catalog/OptionsContainer.h b/Catalog/OptionsContainer.h
index da92e454b0..9a6ba6d55c 100644
--- a/Catalog/OptionsContainer.h
+++ b/Catalog/OptionsContainer.h
@@ -71,7 +71,7 @@ struct OptionsContainer {
     if (clear) {
       options.clear();
     }
-    for (const auto& member : ddl_options.GetObject()) {
+    for (const auto& member : ddl_options.GetObj()) {
       std::string key = to_upper(member.name.GetString());
       options[key] = member.value.GetString();
     }
diff --git a/DataMgr/BufferMgr/BufferMgr.h b/DataMgr/BufferMgr/BufferMgr.h
index 1df594918b..cfbdad4159 100644
--- a/DataMgr/BufferMgr/BufferMgr.h
+++ b/DataMgr/BufferMgr/BufferMgr.h
@@ -34,6 +34,9 @@
 #include "DataMgr/AbstractBuffer.h"
 #include "DataMgr/AbstractBufferMgr.h"
 #include "DataMgr/BufferMgr/BufferSeg.h"
+#if defined(_WIN32)
+#include <WinSock2.h>
+#endif
 #include "Shared/boost_stacktrace.hpp"
 #include "Shared/types.h"
 
diff --git a/DataMgr/ForeignStorage/ArrowForeignStorage.cpp b/DataMgr/ForeignStorage/ArrowForeignStorage.cpp
index 2ac4b41d4f..a68f46d3e6 100644
--- a/DataMgr/ForeignStorage/ArrowForeignStorage.cpp
+++ b/DataMgr/ForeignStorage/ArrowForeignStorage.cpp
@@ -978,11 +978,11 @@ void ArrowCsvForeignStorage::registerTable(Catalog_Namespace::Catalog* catalog,
     df_td = df_td_owned.get();
   }
 
-#ifdef ENABLE_ARROW_4
+// #ifdef ENABLE_ARROW_4
   auto io_context = arrow::io::default_io_context();
-#else
-  auto io_context = arrow::default_memory_pool();
-#endif
+// #else
+//   auto io_context = arrow::default_memory_pool();
+// #endif
   auto arrow_parse_options = arrow::csv::ParseOptions::Defaults();
   arrow_parse_options.quoting = false;
   arrow_parse_options.escaping = false;
diff --git a/StringDictionary/DictRef.h b/StringDictionary/DictRef.h
index 62456859ee..5e9f8cb1dc 100644
--- a/StringDictionary/DictRef.h
+++ b/StringDictionary/DictRef.h
@@ -4,6 +4,7 @@
 #include <cstdint>
 #include <cstdlib>
 #include <functional>
+#include <string>
 
 struct dict_ref_t {
   int32_t dbId;
diff --git a/StringDictionary/StringDictionary.cpp b/StringDictionary/StringDictionary.cpp
index 23cf7262b1..4cb401ade7 100644
--- a/StringDictionary/StringDictionary.cpp
+++ b/StringDictionary/StringDictionary.cpp
@@ -43,6 +43,12 @@
 
 #include "LeafHostInfo.h"
 
+#ifdef _WIN32
+#if defined(ERROR) || defined(INFO) || defined(WARNING) || defined(FATAL)
+#include "Shared/cleanup_global_namespace.h"
+#endif
+#endif
+
 bool g_cache_string_hash{true};
 
 namespace {
diff --git a/ThirdParty/rapidjson/rapidjson/document.h b/ThirdParty/rapidjson/rapidjson/document.h
index eb4be3a38e..90bb46ed92 100644
--- a/ThirdParty/rapidjson/rapidjson/document.h
+++ b/ThirdParty/rapidjson/rapidjson/document.h
@@ -44,6 +44,15 @@ RAPIDJSON_DIAG_OFF(terminate) // ignore throwing RAPIDJSON_ASSERT in RAPIDJSON_N
 #endif
 #endif // __GNUC__
 
+#ifdef GetObject
+// see https://github.com/Tencent/rapidjson/issues/1448
+// a former included windows.h might have defined a macro called GetObject, which affects
+// GetObject defined here. This ensures the macro does not get applied
+#pragma push_macro("GetObject")
+#define RAPIDJSON_WINDOWS_GETOBJECT_WORKAROUND_APPLIED
+#undef GetObject
+#endif
+
 #ifndef RAPIDJSON_NOMEMBERITERATORCLASS
 #include <iterator> // std::iterator, std::random_access_iterator_tag
 #endif
@@ -1456,7 +1465,9 @@ public:
     }
 
     Object GetObject() { RAPIDJSON_ASSERT(IsObject()); return Object(*this); }
+    Object GetObj() { RAPIDJSON_ASSERT(IsObject()); return Object(*this); }
     ConstObject GetObject() const { RAPIDJSON_ASSERT(IsObject()); return ConstObject(*this); }
+    ConstObject GetObj() const { RAPIDJSON_ASSERT(IsObject()); return ConstObject(*this); }
 
     //@}
 
@@ -2584,4 +2595,10 @@ private:
 RAPIDJSON_NAMESPACE_END
 RAPIDJSON_DIAG_POP
 
+
+#ifdef RAPIDJSON_WINDOWS_GETOBJECT_WORKAROUND_APPLIED
+#pragma pop_macro("GetObject")
+#undef RAPIDJSON_WINDOWS_GETOBJECT_WORKAROUND_APPLIED
+#endif
+
 #endif // RAPIDJSON_DOCUMENT_H_
diff --git a/ThirdParty/sqlite3/CMakeLists.txt b/ThirdParty/sqlite3/CMakeLists.txt
index 8cc388235e..660e141fc9 100644
--- a/ThirdParty/sqlite3/CMakeLists.txt
+++ b/ThirdParty/sqlite3/CMakeLists.txt
@@ -6,5 +6,5 @@ else()
   set_source_files_properties(sqlite3.c PROPERTIES COMPILE_FLAGS "-O0 -Wno-unused-value")
 endif()
 
-add_library(sqlite3 sqlite3.c sqlite3.h)
+add_library(sqlite3 SHARED sqlite3.c sqlite3.h)
 target_link_libraries(sqlite3 ${CMAKE_DL_LIBS})
diff --git a/ThirdParty/sqlite3/sqlite3.c b/ThirdParty/sqlite3/sqlite3.c
index 38874ce409..31125ebdc1 100644
--- a/ThirdParty/sqlite3/sqlite3.c
+++ b/ThirdParty/sqlite3/sqlite3.c
@@ -1097,7 +1097,7 @@ extern "C" {
 # define SQLITE_EXTERN extern
 #endif
 #ifndef SQLITE_API
-# define SQLITE_API
+# define SQLITE_API __declspec(dllexport)
 #endif
 #ifndef SQLITE_CDECL
 # define SQLITE_CDECL
-- 
2.33.0.windows.1

